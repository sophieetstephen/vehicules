{% extends "base.html" %}
{% block title %}Gérer la demande – Véhicules{% endblock %}
{% block content %}
<h1 class="h4">Gérer la demande #{{ r.id }}</h1>

<div class="card mb-3">
  <div class="card-body">
    {% if r.start_at.date() != r.end_at.date() %}
    <p><strong>Période :</strong> {{ r.start_at.strftime('%d/%m/%Y') }} {{ slot_label(r, r.start_at) }} → {{ r.end_at.strftime('%d/%m/%Y') }} {{ slot_label(r, r.end_at) }}</p>
    {% else %}
    <p><strong>Période :</strong> {{ r.start_at.strftime('%d/%m/%Y') }} {{ slot_label(r, r.start_at) }}</p>
    {% endif %}
    <p><strong>Motif :</strong> {{ r.purpose or '—' }}</p>
    <p><strong>Covoiturage :</strong> {% if r.carpool %}Oui ({{ r.carpool_with or '—' }}){% else %}Non{% endif %}</p>
    <p><strong>Précisions :</strong> {{ r.notes or '—' }}</p>
  </div>
</div>

<h2 class="h6">Disponibilité des véhicules</h2>
<form method="post">
  <div class="table-responsive">
    <table class="table table-bordered align-middle">
      <thead>
        <tr><th>Véhicule</th><th>Disponible</th><th>Sélection</th></tr>
      </thead>
      <tbody>
      {% for v, free in availability %}
        <tr>
          <td><strong>{{ v.code }}</strong>{% if v.label %} — {{ v.label }}{% endif %}</td>
          <td>{% if free %}✅ Libre{% else %}❌ Occupé{% endif %}</td>
          <td>
            <input type="radio" name="vehicle_id" value="{{ v.id }}"
                   {% if not free %}disabled{% endif %}
                   {% if loop.first %}required{% endif %}>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="3" class="text-center">Aucun véhicule.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <button name="action" value="approve" class="btn btn-success">Approuver avec ce véhicule</button>
  <button name="action" value="reject"  class="btn btn-outline-danger">Refuser</button>
</form>

<form method="post" class="mt-2">
  <button name="action" value="delete" class="btn btn-danger" onclick="return confirm('Supprimer cette réservation ?');">Supprimer la réservation</button>
</form>

{% if day %}
<hr/>
<h2 class="h6">Segmenter la journée du {{ day.strftime('%d/%m/%Y') }}</h2>
<form method="post" class="row g-2">
  <div class="col-md-6">
    <label class="form-label">Véhicule</label>
    <select name="vehicle_id" class="form-select" required>
      {% for v, free in availability %}
        <option value="{{ v.id }}" {% if not free %}disabled{% endif %}>{{ v.code }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12">
    <button name="action" value="segment_day" class="btn btn-primary mt-2">Attribuer ce véhicule</button>
  </div>
</form>
{% endif %}

{% endblock %}
