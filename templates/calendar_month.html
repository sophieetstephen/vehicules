
{% extends "base.html" %}
{% block content %}
{# Calcul mois précédent et suivant #}
{% set prev = start - timedelta(days=1) %}
{% set prev_y = prev.year %}
{% set prev_m = prev.month %}
{% set next_y = end.year %}
{% set next_m = end.month %}

<h1 class="h4">Vue mensuelle (lecture seule)</h1>
<p>
  <a href="{{ url_for('calendar_month', y=prev_y, m=prev_m) }}">&larr;</a>
  Mois: {{ start.strftime('%B %Y') }}
  <a href="{{ url_for('calendar_month', y=next_y, m=next_m) }}">&rarr;</a>
</p>
{% set days = (end - start).days %}
<table class="table table-bordered table-sm align-middle">
  <thead>
    <tr>
      <th style="position: sticky; left:0; background:#fff;">Véhicule</th>
      {% for i in range(days) %}
        <th class="text-center">{{ (start + timedelta(days=(i|int))).strftime("%d") }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for v in vehicles %}
    <tr>
      <td style="position: sticky; left:0; background:#fff;"><strong>{{ v.code }}</strong></td>
      {% for i in range(days) %}
    {% set day = start + timedelta(days=(i|int)) %}
        <td class="text-center" style="min-width:40px;">
          {% for r in reservations if r.vehicle_id==v.id and r.start_at.date() <= day.date() <= r.end_at.date() %}
            <button type="button" class="badge bg-success reservation"
                    data-bs-toggle="modal" data-bs-target="#reservationModal"
                    data-user="{{ r.user.name }}" data-purpose="{{ r.purpose }}">
              {{ r.user.name }}
            </button>
          {% endfor %}
        </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>
<p class="text-muted">Légende : <span class="badge bg-success">Nom du réservant</span> = Réservé (approuvé)</p>
{% if user and user.role in ['admin', 'superadmin'] %}
  <a class="btn btn-outline-secondary" href="{{ url_for('export_pdf_month') }}">Exporter PDF du mois</a>
{% endif %}

<div class="modal fade" id="reservationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Réservation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Nom&nbsp;:</strong> <span class="modal-user"></span></p>
        <p><strong>Motif&nbsp;:</strong> <span class="modal-purpose"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('reservationModal');
    const userEl = modal.querySelector('.modal-user');
    const purposeEl = modal.querySelector('.modal-purpose');
    document.querySelectorAll('.reservation').forEach(function (btn) {
      btn.addEventListener('click', function () {
        userEl.textContent = this.dataset.user || '';
        purposeEl.textContent = this.dataset.purpose || '';
      });
    });
  });
</script>
{% endblock %}
