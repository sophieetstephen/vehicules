
{% extends "base.html" %}
{% block content %}
{# Calcul mois précédent et suivant #}
{% set prev = start - timedelta(days=1) %}
{% set prev_y = prev.year %}
{% set prev_m = prev.month %}
{% set next_y = end.year %}
{% set next_m = end.month %}

<h1 class="h4">Vue mensuelle (lecture seule)</h1>
<p>
  <a href="{{ url_for('calendar_month', y=prev_y, m=prev_m) }}">&larr;</a>
  Mois: {{ start.strftime('%B %Y') }}
  <a href="{{ url_for('calendar_month', y=next_y, m=next_m) }}">&rarr;</a>
</p>
{% set days = (end - start).days %}
<div class="table-responsive">
<table class="table table-bordered table-sm align-middle">
  <thead>
    <tr>
      <th style="position: sticky; left:0; background:#fff;">Véhicule</th>
      {% for i in range(days) %}
        <th class="text-center">{{ (start + timedelta(days=(i|int))).strftime("%d") }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for v in vehicles %}
    <tr>
      <td style="position: sticky; left:0; background:#fff;"><strong>{{ v.code }}</strong></td>
      {% for i in range(days) %}
    {% set day = start + timedelta(days=(i|int)) %}
        <td class="text-center" style="min-width:40px;">
          {% set cell_has_res = false %}
          {% for r in reservations if r.vehicle_id==v.id and r.start_at.date() <= day.date() <= r.end_at.date() %}
            {% set ns = namespace(has_seg=false) %}
            {% for s in segments if s.reservation_id==r.id and s.start_at.date() <= day.date() <= s.end_at.date() %}
              {% set ns.has_seg = true %}
            {% endfor %}
            {% if not ns.has_seg %}
              {% set cell_has_res = true %}
              {% if user and user.role in ['admin', 'superadmin'] %}
                <a href="{{ url_for('manage_request', rid=r.id, day=day.strftime('%Y-%m-%d')) }}" class="badge bg-success">{{ r.user.name }} ({{ slot_label(r, day) }})
                {% if r.purpose %}
                  <br>{{ r.purpose }}
                {% endif %}
                </a>
              {% else %}
                <span class="badge bg-success">{{ r.user.name }} ({{ slot_label(r, day) }})
                {% if r.purpose %}
                  <br>{{ r.purpose }}
                {% endif %}
                </span>
              {% endif %}
            {% endif %}
          {% endfor %}
          {% for s in segments if s.vehicle_id==v.id and s.start_at.date() <= day.date() <= s.end_at.date() %}
            {% set cell_has_res = true %}
            {% if user and user.role in ['admin', 'superadmin'] %}
              <a href="{{ url_for('manage_segment', sid=s.id) }}" class="badge bg-primary">{{ s.reservation.user.name }} ({{ slot_label(s, day) }})
              {% if s.reservation.purpose %}
                <br>{{ s.reservation.purpose }}
              {% endif %}
              </a>
            {% else %}
              <span class="badge bg-primary">{{ s.reservation.user.name }} ({{ slot_label(s, day) }})
              {% if s.reservation.purpose %}
                <br>{{ s.reservation.purpose }}
              {% endif %}
              </span>
            {% endif %}
          {% endfor %}
          {% if not cell_has_res and user and user.role in ['admin', 'superadmin'] %}
            <a href="{{ url_for('new_request') }}" class="d-block w-100 h-100 text-decoration-none">&nbsp;</a>
          {% endif %}
        </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>
<p class="text-muted">Légende : <span class="badge bg-success">Nom du réservant (Matin/Après-midi/Journée)</span> = Réservé (approuvé)</p>
{% if user and user.role in ['admin', 'superadmin'] %}
  <a class="btn btn-outline-secondary" href="{{ url_for('export_pdf_month') }}">Exporter PDF du mois</a>
{% endif %}
{% endblock %}
