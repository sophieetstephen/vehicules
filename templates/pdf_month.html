<!doctype html><html><head><meta charset="utf-8">
<link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/litera/bootstrap.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='custom.css') }}" rel="stylesheet">
{% set days = (end - start).days %}
{% if days <= 28 %}
    {% set font_size = 9 %}
{% elif days <= 30 %}
    {% set font_size = 8.5 %}
{% elif days <= 31 %}
    {% set font_size = 8 %}
{% else %}
    {% set font_size = 7.5 %}
{% endif %}
{% set first_half_limit = 15 if days > 15 else days %}
{% set first_half = range(0, first_half_limit) %}
{% set second_half = range(first_half_limit, days) %}
{% set compact_layout = second_half|length > 15 %}
{% if compact_layout %}
    {% set font_size = 7.2 %}
{% endif %}
<style>
@page{size:A3 landscape;margin:5mm}
body{font-family:sans-serif;font-size:{{ font_size }}px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #999;padding:{{ '0 1px' if compact_layout else '1px 2px' }};vertical-align:top;text-align:center}
th.sticky,td.sticky{position:sticky;left:0;background:#fff}
.badge{padding:0.15rem 0.3rem;line-height:1.1;font-weight:600}
.reservation-details{line-height:1.2;margin-top:1px}
.vehicle-info{min-width:{{ '110px' if compact_layout else '120px' }}}
.planning-table{margin-bottom:24px}
.planning-table:last-of-type{margin-bottom:0}
</style>
{% macro render_day_cell(vehicle, day) %}
<td>
    {% for r in reservations if r.vehicle_id==vehicle.id and r.start_at.date() <= day.date() <= r.end_at.date() %}
    <span class="badge text-bg-success">{{ slot_label(r, day) }}</span>
    {% set full_name = (r.user.first_name or '') ~ (' ' if r.user.first_name and r.user.last_name else '') ~ (r.user.last_name or '') %}
    {% if full_name|trim %}
        {% set reserver_name = full_name|trim %}
    {% else %}
        {% set reserver_name = r.user.name %}
    {% endif %}
    {% set purpose = r.purpose|default('', true)|trim %}
    {% if not purpose %}
        {% set purpose = 'Motif non renseigné' %}
    {% endif %}
    <div class="small text-muted reservation-details">{{ reserver_name }} — {{ purpose }}</div>
    {% endfor %}
</td>
{% endmacro %}
</head><body>
<h1>Planning véhicules — {{ month_year_label(start) }}</h1>
<div class="table-responsive">
{% macro render_table(day_range) %}
<table class="planning-table">
<thead>
<tr>
    <th class="sticky">Véhicule</th>
    {% for i in day_range %}
        {% set day = start + timedelta(days=i) %}
        <th>{{ day.strftime("%d") }}</th>
    {% endfor %}
</tr>
</thead>
<tbody>
{% for v in vehicles %}
<tr class="vehicle-row">
    <td class="sticky vehicle-info"><strong>{{ v.code }}</strong><br>{{ v.label }}</td>
    {% for i in day_range %}
        {% set day = start + timedelta(days=i) %}
        {{ render_day_cell(v, day) }}
    {% endfor %}
</tr>
{% endfor %}
</tbody>
</table>
{% endmacro %}
{{ render_table(first_half) }}
{% if second_half|length > 0 %}
{{ render_table(second_half) }}
{% endif %}
</div>
<p class="legend-text">Légende: Matin / Après-midi / Journée = Réservé (approuvé)</p>
</body></html>
