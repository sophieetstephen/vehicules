{% extends "base.html" %}{% block title %}Administration – Utilisateurs{% endblock %}{% block content %}
<h4 class="mb-3">Utilisateurs</h4>
<form method="get" action="{{ url_for('admin_users') }}" class="mb-3">
  <input type="text" name="q" value="{{ request.args.get('q','') }}" class="form-control" />
  <button type="submit" class="btn btn-primary">Chercher</button>
</form>
<p class="text-muted small mb-2">Les lignes en surbrillance correspondent aux utilisateurs en attente d'activation.</p>
<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead><tr><th>ID</th><th>Prénom</th><th>Nom</th><th>Email</th><th>Rôle</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody>
    {% for u in users %}
      <tr{% if (u.status or '') == 'pending' %} class="table-warning"{% endif %}>
        <td>{{u.id}}</td>
        <td>{{u.first_name or ""}}</td>
        <td>{{u.last_name or ""}}</td>
        <td>{{u.email}}</td>
        <td><span class="badge bg-{{ 'primary' if u.role==ROLE_ADMIN else 'secondary' }}">{{u.role or 'user'}}</span></td>
        <td>
          {% if (u.status or '') == 'pending' %}
            <span class="badge bg-warning">En attente</span>
          {% else %}
            <span class="badge bg-{{ 'success' if (u.status or '')=='active' else ('secondary' if (u.status or '')=='inactive' else 'warning') }}">{{u.status or 'n/a'}}</span>
          {% endif %}
        </td>
        <td class="d-flex gap-2">
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('admin_user_edit', user_id=u.id) }}">Modifier</a>
          {% if (u.status or '') == 'active' %}
            <form method="post" action="{{ url_for('admin_deactivate', user_id=u.id) }}" class="d-inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-warning" type="submit">Désactiver</button>
            </form>
          {% else %}
            <form method="post" action="{{ url_for('admin_activate', user_id=u.id) }}" class="d-inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-success" type="submit">Activer</button>
            </form>
          {% endif %}
          {% if current_user and current_user.role==ROLE_SUPERADMIN %}
            <form method="post" action="{{ url_for('admin_reset_password', user_id=u.id) }}" class="d-inline" onsubmit="return confirm('Réinitialiser le mot de passe ?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-secondary" type="submit">Réinitialiser mot de passe</button>
            </form>
          {% endif %}
          {% if current_user and current_user.role==ROLE_SUPERADMIN and u.role!=ROLE_SUPERADMIN %}
            {% if u.role==ROLE_ADMIN %}
              <form method="post" action="{{ url_for('admin_demote', user_id=u.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-primary" type="submit">Rétrograder</button>
              </form>
            {% else %}
              <form method="post" action="{{ url_for('admin_promote', user_id=u.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-primary" type="submit">Promouvoir admin</button>
              </form>
            {% endif %}
            <form method="post" action="{{ url_for('admin_user_delete', user_id=u.id) }}" class="d-inline" onsubmit="return confirm('Confirmer la suppression ?');">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger" type="submit">Supprimer</button>
            </form>
          {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
